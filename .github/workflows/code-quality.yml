# SPDX-FileCopyrightText: 2025 INFO.nl
# SPDX-License-Identifier: EUPL-1.2+

name: Code quality

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate types
        run: npm run types

      - name: Create .env file from secrets
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Run linting
        run: npm run lint

      - name: Run prettier check
        run: npm run prettier

      - name: Run validation
        run: npm run validate

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload backend test coverage report to Codecov
        if: ${{ github.event_name != 'merge_group' }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: backendunittests
          directory: ./office-backend/coverage

      - name: Upload frontend test coverage report to Codecov
        if: ${{ github.event_name != 'merge_group' }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: frontendunittests
          directory: ./office-add-in/coverage

      - name: Comment PR with test results
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            // Try to read coverage summary
            let coverageComment = '## ðŸ§ª Test Results\n\nâœ… All tests passed!\n\n';
            
            try {
              const coverageExists = fs.existsSync('./coverage/coverage-summary.json');
              if (coverageExists) {
                const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total;
                
                coverageComment += '### Coverage Report\n\n';
                coverageComment += `| Metric | Coverage |\n`;
                coverageComment += `|--------|----------|\n`;
                coverageComment += `| Lines | ${total.lines.pct}% (${total.lines.covered}/${total.lines.total}) |\n`;
                coverageComment += `| Functions | ${total.functions.pct}% (${total.functions.covered}/${total.functions.total}) |\n`;
                coverageComment += `| Branches | ${total.branches.pct}% (${total.branches.covered}/${total.branches.total}) |\n`;
                coverageComment += `| Statements | ${total.statements.pct}% (${total.statements.covered}/${total.statements.total}) |\n`;
              }
            } catch (error) {
              console.log('Could not read coverage report:', error.message);
            }
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸ§ª Test Results')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: coverageComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: coverageComment
              });
            }