# SPDX-FileCopyrightText: 2025 INFO.nl
# SPDX-License-Identifier: EUPL-1.2+

name: Build and Release ZGW Office Addin

on:
  push:
    branches:
      - main
  pull_request:
  merge_group:
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Set up Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
      with:
        node-version-file: '.nvmrc'

    - name: Install dependencies
      run: npm install

    - name: Run code validation
      id: validation
      run: |
        set +e  # Don't fail immediately on error
        npm run check > validation_output.txt 2>&1
        validation_exit_code=$?
        echo "exit_code=$validation_exit_code" >> $GITHUB_OUTPUT
        
        # Always show the output
        cat validation_output.txt
        
        # Exit with the original exit code
        exit $validation_exit_code

    - name: Output validation results
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let validationOutput = '';
          try {
            validationOutput = fs.readFileSync('validation_output.txt', 'utf8');
          } catch (error) {
            validationOutput = 'Could not read validation output';
          }
          
          const exitCode = '${{ steps.validation.outputs.exit_code }}';
          const status = exitCode === '0' ? 'Passed ‚úÖ' : 'Failed ‚ùå';
          const emoji = exitCode === '0' ? 'üéâ' : '‚ö†Ô∏è';
          
          const comment = `${emoji} **Build Validation ${status}**
          
          <details>
          <summary>üìã Validation Output</summary>
          
          \`\`\`
          ${validationOutput.slice(0, 4000)}${validationOutput.length > 4000 ? '\n... (output truncated)' : ''}
          \`\`\`
          
          </details>
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Build project
      run: npm run build

    - name: Package Artifacts
      run: |
        mkdir -p release
        cp -r office-add-in/dist release/

    - name: Archive Artifacts for release zip
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: office-addin-artifacts
        path: release/

    - name: Archive Artifacts for docker image
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: office-addin-build-artifacts-docker
        path: |
          office-add-in/dist/
          office-backend/dist/

  next-version:
    runs-on: ubuntu-24.04
    outputs:
      old-version: ${{ github.ref == 'refs/heads/main' && steps.get-tag-main.outputs.old_tag || steps.get-tag-non-main.outputs.old_tag }}
      version: ${{ github.ref == 'refs/heads/main' && steps.get-tag-main.outputs.new_tag || steps.get-tag-non-main.outputs.new_tag }}
    steps:
    # Checkout the repository including tags
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0
    # Determine the next semantic version based on the commit message tags
    - name: Get next tag on main
      id: get-tag-main
      if: ${{ github.ref == 'refs/heads/main'}}
      uses: anothrNick/github-tag-action@4ed44965e0db8dab2b466a16da04aec3cc312fd8 # 1.75.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PRERELEASE: false
        DEFAULT_BUMP: patch
        WITH_V: true
        RELEASE_BRANCHES: main
    # If not on main, Determine the next semantic version based on the commit message tags without pushing tags`
    - name: Get next tag on non-main
      id: get-tag-non-main
      if: ${{ github.ref != 'refs/heads/main'}}
      uses: anothrNick/github-tag-action@4ed44965e0db8dab2b466a16da04aec3cc312fd8 # 1.75.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PRERELEASE: false
        DEFAULT_BUMP: patch
        WITH_V: true
        RELEASE_BRANCHES: main
        DRY_RUN: true
    - name: Print new version
      run: |
        echo "Next version: ${{ github.ref == 'refs/heads/main' && steps.get-tag-main.outputs.new_tag || steps.get-tag-non-main.outputs.new_tag }}"

  create-release:
    needs: [build,next-version]
    runs-on: ubuntu-24.04
    if: ${{ github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, 'update zgw-office-addin-docker-images to') }}
    steps:

    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Download office-addin-artifacts
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
      with:
        name: office-addin-artifacts
        path: release-${{ needs.next-version.outputs.version }}/

    - name: Create zip
      run: |
        zip -r zgw-office-addin-${{ needs.next-version.outputs.version }}.zip release-${{ needs.next-version.outputs.version }}

    - name: Create Github release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh release create ${{ needs.next-version.outputs.version }} zgw-office-addin-${{ needs.next-version.outputs.version }}.zip --notes-start-tag ${{ needs.next-version.outputs.old-version }} --generate-notes

  create-docker-image:
    needs: [build,next-version]
    runs-on: ubuntu-24.04
    if: ${{ !contains(github.event.head_commit.message, 'update zgw-office-addin-docker-images to') }}
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Download office-addin-artifacts for docker build
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
      with:
        name: office-addin-build-artifacts-docker

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build (and Push) Frontend Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        file: ./office-add-in/Dockerfile
        context: .
        push: ${{ github.ref == 'refs/heads/main' }}
        tags: |
          ghcr.io/infonl/zgw-office-add-in-frontend:latest
          ghcr.io/infonl/zgw-office-add-in-frontend:${{ needs.next-version.outputs.version }}
        attests: |
          type=provenance,mode=max
          type=sbom

    - name: Build (and Push) Backend Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        file: ./office-backend/Dockerfile
        context: .
        push: ${{ github.ref == 'refs/heads/main' }}
        tags: |
          ghcr.io/infonl/zgw-office-add-in-backend:latest
          ghcr.io/infonl/zgw-office-add-in-backend:${{ needs.next-version.outputs.version }}
        attests: |
          type=provenance,mode=max
          type=sbom

  trigger-provision:
    needs: [next-version, create-docker-image]
    env:
      NEXT_VERSION: ${{ needs.next-version.outputs.version }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    if: ${{ github.ref == 'refs/heads/main' && vars.ENABLE_AUTOMATIC_PROVISION == 'true' }}
    steps:
      - uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          github-token: ${{ secrets.PROVISION_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'infonl',
              repo: 'dimpact-provisioning',
              workflow_id: 'azure-provision-zgw-office-addin.yml',
              inputs: {
                tag: '${{ env.NEXT_VERSION }}',
              },
              ref: 'main'
            })
